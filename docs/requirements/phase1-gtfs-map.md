# フェーズ1 要件: GTFS＋バス停の全可視化と統合時刻表表示

## 目的
- GTFS フィードから広電およびその他事業者のバス停・便情報を読み取り、地図上にバス停を可視化する。
- 任意のバス停をクリックした際に、「広電」と「その他事業者」の便を 1 つのテーブルとして時刻順に表示できるようにする。
- ダイヤ計画担当が、まず「現状の時刻表（自社＋他社）」を 1 画面で確認できる状態を作る。

## 入力データと前提
- 入力は `gtfs/` ディレクトリに保存された GTFS ZIP（複数事業者分）とする。
- 各 GTFS ZIP には少なくとも以下の標準ファイルが含まれている前提とする。
  - `stops.txt`
  - `trips.txt`
  - `stop_times.txt`
  - `routes.txt`
  - `calendar.txt` / `calendar_dates.txt`（運行日判定のため）
- 広電かどうかの判定ロジックは、基本的に `agency.txt` の `agency_name` を用いる。
  - 初期実装では、`agency_name` に「広島電鉄」を含む事業者を「広電」とみなし、それ以外を「その他事業者」とする。
  - 将来的に別名・英語表記・例外が必要になった場合は、`agency_id` / `agency_name` をキーとした設定ファイル（例: `config/agency-groups.json`）で「hiroden」「other」等のグルーピングを上書きできるようにする。

## 機能要件

### 1. 地図上でのバス停可視化
- バックエンドを持たない静的 Web アプリとして、ブラウザ上で以下を実現する。
  - ベースマップ（例: OSM）上に、GTFS の `stops.txt` に含まれる停留所をマーカーとして表示する。
  - 複数事業者の GTFS を読み込んだ場合でも、同一位置または同一停留所とみなすべきバス停は 1 つのマーカーとして表現する。
    - 初期実装では、次の両方を満たす場合に「同一停留所」とみなして統合する。
      1. 緯度経度の距離が 30m 以下
      2. `stop_name` を全角/半角・空白・「バス停」「（のりば）」などの装飾を正規化したときに一致する
    - 上記条件に当てはまらない停留所は別マーカーとして扱う。
    - 将来的な例外（手動マスタによる統合）が必要になった場合は、別途 CSV 等で対応する。

### 2. 停留所クリックでの統合時刻表表示
- 地図上の任意のバス停マーカーをクリックした際に、画面のサイドパネルまたはモーダルで次を表示する。
  - 選択した停留所を発着するすべての便（trip）の時刻表。
  - 広電とその他事業者の便を 1 つのテーブルに時刻順で並べる。
  - 行ごとに以下のような情報を表示する（暫定案）。
    - 事業者名
    - 系統・路線名
    - 発時刻（必要なら着時刻）
    - 行き先（destination）
  - TODO: テーブルに表示すべき列（事業者名／系統番号／行き先など）の最小セットを確定する。

### 3. 事業者フィルタ
- 統合時刻表の表示部分で、次の切り替えができる。
  - 広電のみ
  - その他事業者のみ
  - 全社
- フィルタの UI はトグルボタンやチェックボックスなどシンプルな形とし、将来的に事業者個別選択（中国バスだけ等）に拡張できるよう意識しておく。

### 4. 日付・曜日の取り扱い（暫定）
- フェーズ1の初期実装では、「平日ダイヤ（通常日）」に限定して時刻表を表示する。
  - `calendar.txt` / `calendar_dates.txt` を用いて、指定日のサービスが平日パターンに該当する便のみを抽出する。
- 将来的には、曜日や特定日（祝日／イベント日）で切り替えられる UI を追加可能な構成にしておく。

## UI 要件（最小）
- PC ブラウザでの利用を主ターゲットとする（Chrome / Edge 最新版程度）。
- 1 画面に以下の要素を含める。
  - 左（または中央）: 地図ビュー（バス停マーカー付き）
  - 右（または下部）: 選択停留所の統合時刻表パネル
- 統合時刻表パネルでは、以下を満たす。
  - 時刻順にスクロールできるテーブル（縦方向スクロール）
  - 広電とその他事業者を色またはラベルで視覚的に区別できる。
- UI コンポーネントは `shadcn/ui` をベースとし、ボタンやタブ、テーブルなどの標準コンポーネントを活用する。
- UI 上のラベル・ボタン・メニュー等の文言は、日本語で表記し、バス計画担当者が直感的に理解できる用語を優先する（英語のみのラベルは避ける）。

## 非機能要件（フェーズ1時点）
- パフォーマンス:
  - 対象エリアは広電＋周辺コミバス程度を想定し、1?数千停留所規模でも操作に支障が出ないことを目標にする。
  - ただしフェーズ1では PoC レベルとし、必要に応じて事業者やエリアを絞って表示する。
- オフライン性:
  - フェーズ1ではオンライン前提（地図タイル取得のため）。オフライン利用は検討対象外。

## TODO / 要確認事項
- 広電以外の事業者で、特別に「広電グループ」として扱うべきものがあるかどうか（設定ファイルで対応）。
- 停留所統合ロジック（30m以内＋正規化後の `stop_name` 一致）で問題が出た場合に、どのような手動マスタ（CSV 等）で補正するか。
- 平日以外（休日・特定日）をどのタイミングで UI に追加するか。
- 時刻表テーブルに追加したい列（のりば番号、備考など）があるかどうか。

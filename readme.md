# （仮）GTFS可視化・配布時刻表スタジオ README

> 「ダイヤ改正の 2〜3 ヶ月、
> “この画面なしでは仕事したくない” を目指すツール」

---

## 1. ユーザー体験（UXストーリー）※この章がプロダクトの骨子

> フェーズ1〜3で順に深くなっていく想定です。  
> 1-1 がフェーズ1、1-2 がフェーズ2、1-3 がフェーズ3（案）に対応します。

### 1-1. フェーズ1: ダイヤ改正プロジェクトの最初の1日（現状把握）

> **登場人物：広電のダイヤ計画担当・Aさん**

1. Aさんは、春のダイヤ改正プロジェクトのキックオフで
   「今年は JR やコミバスとの乗り継ぎをもう少し良くしよう」と言われる。
2. デスクに戻り、ブラウザで
   **「GTFS可視化・配布時刻表スタジオ」**を開く。
3. 画面上部で

   * 改正ラベル：`2026年春ダイヤ改正`
   * 対象エリア：`〇〇地区（広電＋JR＋コミバス）`
     を選択し、「プロジェクトを開始」ボタンをクリック。
4. 地図と停留所一覧が表示され、
   任意の停留所をクリックすると、

   * **自社（広電）＋他社（JR・コミバス）の全便の時刻表**が
     時間順に1つのリストとして表示される。
5. フィルタで

   * 「広電だけ」
   * 「JR＋広電」
   * 「すべての事業者」
     を切り替えながら、**まずは“現状のダイヤ”を直感的に把握**していく。

→ Aさんは「まずはいつも混む〇〇停留所から見ていこう」と決め、
他社便を眺めながら、新しい自社便の候補案を頭の中で描き始める。

---

### 1-2. フェーズ2: 検討が進んだら「配付時刻表をワンクリックで」

1. ダイヤ案が固まりつつあるタイミングで、
   Aさんは画面右上の **「配付時刻表を生成」ボタン**を押す。
2. 出てくるダイアログで、

   * 出力対象：`〇〇地区・A停留所〜C停留所`
   * フォーマット：

     * `停留所掲示用 A4縦 3段`
     * `地域パンフレット用 A3横 2面`
       を選択。
3. プレビュー画面では、

   * 高齢者でも読みやすいフォントサイズ
   * 「広電」「JR」「コミバス」が色分けされた時刻表
     が表示される。
4. 「PDF出力」をクリックすると、

   * 印刷会社や社内配付に回せる形の**最終版に近いレイアウト**がダウンロードされる。

→ Aさんは「これまで Excel で地獄のコピペをしていた作業」を
　ほぼ自動で済ませることができる。

---

### 1-3. フェーズ3（案）: 任意地点からの到達圏を一目で把握する

1. 将来的に、Aさんは「〇〇病院から30分以内で来られるエリアを把握したい」と考える。
2. ツールの「到達圏可視化」タブを開き、

   * 基準地点：`〇〇病院`（または地図上で任意地点をクリック）
   * 出発時刻：`平日 7:30 発`
   * 最大所要時間：`30 分`

   を指定して「到達圏を計算」ボタンを押す。
3. 地図上で、路線バスを利用して 30 分以内に到達できる停留所やエリアが色分けされて表示される。
4. Aさんは「通院に使いやすいエリア」「サービスが届いていないエリア」を視覚的に把握し、
   将来の路線見直しやダイヤ改善の候補を検討できる。

→ 単なる停留所単位の時刻表表示だけでなく、
**「地域全体のアクセス性」を地図上で直感的に議論できる**体験を目指す（フェーズ3以降で検討）。

---

### 1-4. ダイヤ改正期間（2〜3ヶ月）を通じての使われ方

* 改正プロジェクトの期間中、

  * Aさんは**ほぼ毎日、このツールを立ち上げる。**
  * フェーズ1の機能で「他社を含めた現状の見える化」を行い、
  * フェーズ2の機能で「配付時刻表の生成」を行う。
  * 将来的には、フェーズ3以降の機能で「到達圏や乗り継ぎの偏り」を定量的に把握する。
* 結果として、

  * 「他社時刻表を紙や別タブで見ながら…」という**ムダな往復**が減り、
  * 「どの停留所・エリアが本当に問題か」を定量的に説明できるようになる。

→ この UX が、このプロダクトの **“コア体験”** であり、フェーズを重ねるごとに深まっていくイメージです。

---

## 2. プロダクト概要

**プロダクト名（仮）：GTFS可視化・配布時刻表スタジオ**

* 複数事業者の GTFS（＋手動入力）を取り込み、
  ダイヤ計画担当のための

  * **他社ダイヤ可視化**
  * **乗り継ぎ評価**
  * **配付時刻表自動生成**
    を行う業務支援ツールです。

* 特徴：

  * 「計画担当の 2〜3 ヶ月」を支える**プロジェクトインフラ**であること
  * 年 1 回のイベントでも、その期間中は**毎日使う“仕事の画面”**になること

---

## 3. 想定ユーザー

* バス・鉄道事業者の

  * ダイヤ計画担当
  * 企画・計画部門
* 自治体・地域公共交通コーディネーター（閲覧・分析用）
* 交通系コンサルタント（分析・報告書作成用）

---

## 4. 主な機能

### 4-1. GTFS & ローカル時刻データ統合

* 公開されている GTFS フィードを読み込み、

  * 停留所
  * 系統・路線
  * 便（trip）
  * カレンダー
    を自動で取り込む。
* GTFSが存在しない事業者については、

  * CSV / Excel / 手入力ベースで「簡易GTFS」を作成できる UIを提供。
* GTFS＋簡易GTFSをまとめて「地域時刻表空間」として扱う。

### 4-2. 停留所単位の時刻表統合表示

* 任意の停留所を選ぶと、

  * 自社＋他社の全便が**時間順に1つのテーブル**で表示。
* 絞り込み条件：

  * 事業者別（自社のみ／他社のみ／全社）
  * 曜日・運行日（平日／土休日／特定日）
  * 上り／下り

### 4-3. 乗り継ぎ性評価（簡易アナリティクス）

* 指定した停留所ペア（例：広電→JR）について、

  * 乗り継ぎ待ち時間の分布
  * 待ち時間 xx 分以上のケース数
  * 便ごとの乗り継ぎマッチング一覧
    を自動算出。
* 「待ち時間 xx 分以内を満たすための、自社便時刻の調整幅候補」を計算（※最終判断は人）。

### 4-4. 配付時刻表自動生成

* 出力対象を選択：

  * 停留所単位
  * エリア単位（複数停留所をまとめたパンフレット形式）
* テンプレート選択：

  * 停留所掲示用 A4 縦・横
  * パンフレット用 A3 など
* PDF生成（印刷所／社内配布にそのまま渡せるレベル）
  ※レイアウトエンジンはテンプレートでカスタマイズ可能

### 4-5. プロジェクト管理

* 「2026春ダイヤ」「2027春ダイヤ」など改正単位でプロジェクトを作成。
* プロジェクトごとに

  * 使用したデータセット（GTFSバージョン）
  * 各停留所の乗り継ぎ評価結果
  * 出力した配付時刻表の履歴
    を保存・再利用。

### 4-6. 到達圏可視化（将来検討）

* 任意の地点（例：病院・主要駅）と出発時刻・最大所要時間を指定すると、
  路線バスを利用して到達可能な停留所やエリアを地図上に可視化する。
* 到達可能な停留所リストや、到達圏を示す色分けポリゴンなどを表示し、
  「サービスが届いている／届いていない」エリアを議論できるようにする。

---

## 5. データ要件

* 入力：

  * GTFS フィード（複数事業者）
  * 簡易 GTFS（CSV/Excel/手入力から生成）
* 出力：

  * 内部DB（PostgreSQL等）に正規化して保存
  * 配付時刻表 PDF / HTML
  * 乗り継ぎ評価レポート（CSV / PDF）

---

## 6. 技術スタック（案）

* フロントエンド：

  * TypeScript + React
  * 地図表示：Leaflet or MapLibre
* バックエンド：

  * Python / Node.js
  * GTFSパーサー・集計ロジック
* データベース：

  * PostgreSQL（＋PostGIS）
* インフラ：

  * クラウド（AWS / GCP など）、コンテナデプロイを想定

※ README 時点ではあくまで案。PoC で決定。

---

## 7. 導入メリット（ユーザー目線）

* 他社含めた時刻表を**1画面で見ながらダイヤ検討**できる
* 「乗り継ぎが悪い区間」が**感覚ではなく数値で分かる**
* 配付時刻表を**Excel職人の作業に頼らず**に作成できる
* GTFSが公開されていない事業者も、最低限の手入力で巻き込める
* ダイヤ改正の 2〜3 ヶ月間、計画担当にとっての**“ホーム画面”**になり得る

---

## 8. 今後の拡張アイデア（メモ）

* ダイヤ作成システムとの API 連携（案のインポート／エクスポート）
* 将来的な B 案（連携フロー可視化）の一部取り込み
  → GTFS 公開日時や各バージョンの履歴表示
* 住民向け Web 時刻表（軽量版）の自動ホスティング
* 乗り継ぎ評価ロジックの高度化（遅延データの組み込み等）

---

## 9. 現時点の試作実装（フェーズ1試作）

フェーズ1の要件確認後に実装した最小機能セットです。今後の追加実装も本節に追記して育てていきます。

### 9-1. 技術スタック（実装済み）
- Vite + React + TypeScript のシングルページ構成（`npm run build` で静的出力）。
- 地図表示は Leaflet + react-leaflet（OSM タイル）。停留所密度が高い箇所は Supercluster でクラスタ表示。
- スタイルは Tailwind ベースで最小限（shadcn/ui 相当のボタンを自前定義）。
- ブラウザ内で JSZip と簡易 CSV パーサを用いて GTFS ZIP を直接解析（バックエンド不要）。

### 9-2. データ読み込みと事業者判定
- 画面ヘッダのファイル入力から複数 GTFS ZIP を選択し、`agency/stops/routes/trips/stop_times/shapes` を読み込み。
- `agency_name` に「広島電鉄」を含むデータセットを `isHiroden=true` とみなし、それ以外は「その他事業者」。画面右のチェックボックスで dataset 単位に表示 ON/OFF 可能。
- `calendar.txt` の曜日フラグで「平日（mon?fri いずれか 1）」に運行する `service_id` のみを採用し、統合時刻表を平日ダイヤに絞り込み。

### 9-3. 停留所統合ロジック
- `stop_name` を空白・括弧・「バス停」「のりばn」などを除去した正規化文字列＋30m 以内の距離で突合し、同一停留所として集約。
- 集約後の代表座標は、元の停留所座標の平均（重心）で補正。

### 9-4. UI とフィルタ
- 地図: 統合停留所マーカーを表示し、クリックで選択。クラスタはクリックでズーム。`shapes.txt` を色分け折れ線（広電=緑系、その他=グレー系）でオーバーレイする表示オプションあり。停留所／ルート線の表示 ON/OFF トグルを個別に用意。
- 時刻表パネル: 選択停留所を通る全便を、広電＋その他をまとめて発時刻順にテーブル表示。事業者名・系統（short/long name を優先）・行先・発時刻を列挙し、`全社 / 広電のみ / その他のみ` のフィルタボタンで切替可能。広電の行は背景で薄く強調。
- ルート線は `shape_pt_sequence` でソートして折れ線化し、広電/その他で色分け。
- プレビュー: 選択停留所から「配布時刻表プレビュー」を開き、時刻表を時台ごとに区分した A4 縦レイアウトで表示。広電/その他を色分けし、印刷ボタンから PDF/紙出力を想定。

### 9-5. 現時点の制約・今後の追加候補
- 平日ダイヤ判定は `calendar.txt` の曜日フラグのみ使用（`calendar_dates.txt` の例外や指定日切替、運行期間の始端・終端チェックは未対応）。  
- データ永続化やリモート取得は未対応。ページ更新で状態はリセットされる。  
- スクリーンショットや具体的なサンプル検証は今後追加予定。

---

## 10. フェーズ2（配布時刻表）のレイアウト検討メモ
- A4 縦・片面を標準とするレイアウト詳細を `docs/requirements/phase2-stop-timetable.md` に追記（余白、フォント目安、色分け、ブロック構成、印刷 CSS の想定）。
- 実装時は同ドキュメントの「暫定レイアウト詳細（v0 案）」を起点にし、実機印刷での可読性検証結果を反映させる。必要に応じてフォントサイズ・配色は調整する。
